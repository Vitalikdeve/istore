<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Вход / Регистрация</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f2f7; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box;}
        button { width: 100%; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-login { background: #0071e3; color: white; }
        .btn-reg { background: #34c759; color: white; }
        h2 { margin-top: 0; }
        
        /* Скрытый блок капчи */
        #captcha-block { display: none; margin-top: 10px; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        .captcha-img { border-radius: 5px; cursor: pointer; margin-bottom: 5px; width: 100%; }
        small { color: #888; font-size: 12px; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="title">Вход</h2>
        
        <div style="margin-bottom: 20px; font-size: 14px;">
            <span id="tabLogin" onclick="switchTab('login')" style="font-weight:bold; cursor:pointer; color:#0071e3">Войти</span> | 
            <span id="tabReg" onclick="switchTab('reg')" style="cursor:pointer; color:#888">Регистрация</span>
        </div>

        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="Пароль">
        
        <div id="captcha-block">
            <small>Нажмите на картинку, чтобы обновить</small>
            <div id="svg-container" onclick="loadCaptcha()"></div>
            <input type="text" id="captchaInput" placeholder="Введите код с картинки">
        </div>

        <button id="mainBtn" class="btn-login" onclick="submitForm()">Войти</button>
        <p id="msg" style="color:red; margin-top:10px;"></p>
    </div>

<script>
    let currentMode = 'login'; // login или reg

    function switchTab(mode) {
        currentMode = mode;
        const btn = document.getElementById('mainBtn');
        const captchaBlock = document.getElementById('captcha-block');
        const title = document.getElementById('title');
        
        // Меняем стили вкладок
        document.getElementById('tabLogin').style.color = mode === 'login' ? '#0071e3' : '#888';
        document.getElementById('tabLogin').style.fontWeight = mode === 'login' ? 'bold' : 'normal';
        document.getElementById('tabReg').style.color = mode === 'reg' ? '#0071e3' : '#888';
        document.getElementById('tabReg').style.fontWeight = mode === 'reg' ? 'bold' : 'normal';

        if (mode === 'login') {
            title.innerText = "Вход";
            btn.innerText = "Войти";
            btn.className = "btn-login";
            captchaBlock.style.display = 'none';
        } else {
            title.innerText = "Регистрация";
            btn.innerText = "Создать аккаунт";
            btn.className = "btn-reg";
            captchaBlock.style.display = 'block';
            loadCaptcha(); // Загружаем картинку
        }
    }

    // Загрузка картинки с сервера
    async function loadCaptcha() {
        const res = await fetch('/api/captcha');
        const svg = await res.text();
        document.getElementById('svg-container').innerHTML = svg;
    }

    async function submitForm() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('pass').value;
        const captchaAnswer = document.getElementById('captchaInput').value;
        const msg = document.getElementById('msg');
        
        msg.innerText = "";
        
        const url = currentMode === 'login' ? '/api/login' : '/api/register';
        const body = { email, password };
        
        // Если регистрация - добавляем ответ на капчу
        if (currentMode === 'reg') {
            body.captchaAnswer = captchaAnswer;
        }

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            const data = await res.json();

            if (data.success) {
                localStorage.setItem('userId', data.userId);
                localStorage.setItem('isAdmin', data.isAdmin);
                if (data.isAdmin) window.location.href = '/admin.html';
                else window.location.href = '/profile.html';
            } else {
                msg.innerText = data.error;
                // Если ошибка в капче - обновляем её
                if (currentMode === 'reg') loadCaptcha();
            }
        } catch (e) { alert('Ошибка сервера'); }
    }
</script>
</body>
</html>