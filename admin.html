<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>iStore Admin Pro</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f2f2f7; padding: 40px; color: #1c1c1e; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e5e5ea; border-radius: 10px; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }
        
        .btn { border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background: #0071e3; width: 100%; }
        .btn-del { background: #ff3b30; font-size: 12px; padding: 5px 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 15px 0; border-bottom: 1px solid #e5e5ea; vertical-align: middle; }
        img.thumb { width: 50px; height: 50px; object-fit: contain; border-radius: 5px; border: 1px solid #eee; }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ */
        select.status-select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center">
        <h1>üîê –ö–∞–±–∏–Ω–µ—Ç –ë–æ—Å—Å–∞</h1>
        <button onclick="logout()" style="background:#eee; color:black; border:none; padding:10px 20px; border-radius:10px; cursor:pointer">–í—ã–π—Ç–∏</button>
    </div>

    <div class="card" style="border: 2px solid #0071e3;">
        <h2>‚ú® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h2>
        <div class="row">
            <input type="text" id="pName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="text" id="pSpecs" placeholder="–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è">
        </div>
        <div class="row">
            <input type="number" id="pPrice" placeholder="–¶–µ–Ω–∞">
            <input type="text" id="pImg" placeholder="–§–æ—Ç–æ">
        </div>
        <button class="btn btn-add" onclick="saveProduct()">–î–æ–±–∞–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
        
        <details style="margin-top:20px; cursor:pointer;">
            <summary>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤</summary>
            <table><tbody id="productsTable"></tbody></table>
        </details>
    </div>

    <div class="card">
        <h2>üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>
        <table>
            <thead>
                <tr style="text-align:left; color:#888;">
                    <th>ID</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–¢–æ–≤–∞—Ä—ã</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody id="ordersList"></tbody>
        </table>
    </div>
</div>

<script>
    // 1. –ü–†–û–í–ï–†–ö–ê –í–•–û–î–ê
    const userId = localStorage.getItem('userId');
    const isAdmin = localStorage.getItem('isAdmin');

    // –ï—Å–ª–∏ –Ω–µ –≤–æ—à–µ–ª –∏–ª–∏ –Ω–µ –∞–¥–º–∏–Ω - –≤—ã–∫–∏–¥—ã–≤–∞–µ–º
    if (!userId || isAdmin !== 'true') {
        window.location.href = '/login.html';
    }

    // 2. –ó–ê–ì–†–£–ó–ö–ê
    async function loadData() {
        // –¢–æ–≤–∞—Ä—ã
        const resP = await fetch('/api/products');
        const products = await resP.json();
        document.getElementById('productsTable').innerHTML = products.map(p => `
            <tr>
                <td><img src="${p.img}" class="thumb"></td>
                <td><b>${p.name}</b></td>
                <td>$${p.price}</td>
                <td><button class="btn btn-del" onclick="deleteProduct(${p.id})">üóë</button></td>
            </tr>
        `).join('');

        // –ó–∞–∫–∞–∑—ã (–ó–ê–ü–†–ê–®–ò–í–ê–ï–ú –£ API)
        const resO = await fetch('/api/admin/orders');
        const orders = await resO.json();

        document.getElementById('ordersList').innerHTML = orders.reverse().map(o => `
            <tr>
                <td>#${o.orderId.split('-')[1]}</td>
                <td style="font-size:12px; color:#555;">${o.userId === 'guest' ? '–ì–æ—Å—Ç—å' : '–ö–ª–∏–µ–Ω—Ç'}</td>
                <td>${o.items.map(i => i.name).join(', ')}</td>
                <td><b>$${o.total}</b></td>
                <td>
                    <select class="status-select" onchange="changeStatus('${o.orderId}', this.value)" style="background: ${getStatusColor(o.status)}">
                        <option value="–í –æ–±—Ä–∞–±–æ—Ç–∫–µ üïí" ${o.status.includes('–æ–±—Ä–∞–±–æ—Ç–∫–µ') ? 'selected' : ''}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ üïí</option>
                        <option value="–û—Ç–ø—Ä–∞–≤–ª–µ–Ω üöö" ${o.status.includes('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω') ? 'selected' : ''}>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω üöö</option>
                        <option value="–î–æ—Å—Ç–∞–≤–ª–µ–Ω ‚úÖ" ${o.status.includes('–î–æ—Å—Ç–∞–≤–ª–µ–Ω') ? 'selected' : ''}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω ‚úÖ</option>
                        <option value="–û—Ç–º–µ–Ω–µ–Ω ‚ùå" ${o.status.includes('–û—Ç–º–µ–Ω–µ–Ω') ? 'selected' : ''}>–û—Ç–º–µ–Ω–µ–Ω ‚ùå</option>
                    </select>
                </td>
            </tr>
        `).join('');
    }

    // 3. –°–ú–ï–ù–ê –°–¢–ê–¢–£–°–ê
    async function changeStatus(orderId, newStatus) {
        await fetch('/api/orders/' + orderId + '/status', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status: newStatus })
        });
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª—Å—è —Ü–≤–µ—Ç
        loadData();
    }

    function getStatusColor(status) {
        if(status.includes('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω')) return '#ffcc00'; // –ñ–µ–ª—Ç—ã–π
        if(status.includes('–î–æ—Å—Ç–∞–≤–ª–µ–Ω')) return '#34c759'; // –ó–µ–ª–µ–Ω—ã–π
        if(status.includes('–û—Ç–º–µ–Ω–µ–Ω')) return '#ff3b30';   // –ö—Ä–∞—Å–Ω—ã–π
        return '#fff'; // –ë–µ–ª—ã–π
    }

    // (–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: saveProduct, deleteProduct —Ç–µ –∂–µ)
    async function saveProduct() {
        const data = {
            name: document.getElementById('pName').value,
            price: document.getElementById('pPrice').value,
            img: document.getElementById('pImg').value,
            specs: document.getElementById('pSpecs').value
        };
        await fetch('/api/products', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
        loadData();
    }
    
    async function deleteProduct(id) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await fetch('/api/products/'+id, {method:'DELETE'}); loadData(); }
    }

    function logout() { localStorage.clear(); window.location.href = '/login.html'; }

    loadData();
</script>
</body>
</html>