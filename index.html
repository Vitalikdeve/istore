<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>iStore</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #f5f5f7; --card-bg: #ffffff; --text: #1d1d1f; --accent: #0071e3;
        }
        body.dark-mode {
            --bg: #1c1c1e; --card-bg: #2c2c2e; --text: #f5f5f7; --accent: #0a84ff;
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        
        /* –®–ê–ü–ö–ê */
        header { background: var(--card-bg); padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .logo { font-weight: bold; font-size: 24px; color: var(--text); text-decoration: none; margin-right: 20px; }
        
        /* –ü–æ–∏—Å–∫ –∏ –§–∏–ª—å—Ç—Ä—ã */
        .controls { flex-grow: 1; display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .search-box input { padding: 10px 15px; border-radius: 20px; border: 1px solid #d2d2d7; outline: none; }
        .filter-btn { background: var(--bg); border: 1px solid #d2d2d7; padding: 8px 15px; border-radius: 15px; cursor: pointer; color: var(--text); white-space: nowrap; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* –ò–∫–æ–Ω–∫–∏ —Å–ø—Ä–∞–≤–∞ */
        .nav-icons { display: flex; gap: 15px; align-items: center; margin-left: 10px; }
        .nav-icons a, .theme-btn { text-decoration: none; font-size: 22px; cursor: pointer; position: relative; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; }

        /* –¢–û–í–ê–†–´ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; text-align: center; transition: 0.3s; position: relative; display: flex; flex-direction: column; justify-content: space-between; height: 380px; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 180px; object-fit: contain; margin-bottom: 15px; }
        
        /* –°–µ—Ä–¥–µ—á–∫–æ */
        .heart-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; opacity: 0.3; transition: 0.2s; }
        .heart-btn.liked { opacity: 1; transform: scale(1.2); }

        .btn { background: var(--accent); color: white; padding: 10px; border-radius: 12px; border: none; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        
    </style>
</head>
<body>

    <header>
        <a href="/" class="logo">Ô£ø</a>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="applyFilters()">
            </div>
            <button class="filter-btn active" onclick="setCategory('all')">–í—Å–µ</button>
            <button class="filter-btn" onclick="setCategory('iPhone')">iPhone</button>
            <button class="filter-btn" onclick="setCategory('Mac')">Mac</button>
            <button class="filter-btn" onclick="setCategory('Watch')">Watch</button>
            <button class="filter-btn" onclick="toggleFavoritesShow()" id="favFilterBtn">‚ù§Ô∏è –õ—é–±–∏–º—ã–µ</button>
        </div>

        <div class="nav-icons">
            <span class="theme-btn" onclick="toggleTheme()">üåó</span>
            <a href="/profile.html">üë§</a>
            <a href="/cart.html">üõí <span id="cartCount" class="cart-badge">0</span></a>
        </div>
    </header>

    <div class="grid" id="products-container">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<script>
    let allProducts = [];
    let currentCategory = 'all';
    let showOnlyFavorites = false;

    // 1. –ó–ê–ì–†–£–ó–ö–ê
    async function load() {
        // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        updateCartCount();

        // –¢–æ–≤–∞—Ä—ã
        try {
            const res = await fetch('https://istore-i9oo.onrender.com/api/products');
            allProducts = await res.json();
            applyFilters();
        } catch(e) { console.error(e); }
    }

    // 2. –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –û–¢–†–ò–°–û–í–ö–ê
    function applyFilters() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        const filtered = allProducts.filter(p => {
            const matchesSearch = p.name.toLowerCase().includes(query);
            // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ø—Ä–æ—Å—Ç–æ –∏—â–µ–º —Å–ª–æ–≤–æ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏)
            const matchesCategory = currentCategory === 'all' || p.name.includes(currentCategory);
            // –§–∏–ª—å—Ç—Ä –ø–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–º—É
            const matchesFav = !showOnlyFavorites || favorites.includes(p.id);

            return matchesSearch && matchesCategory && matchesFav;
        });

        render(filtered);
    }

    function render(products) {
        const container = document.getElementById('products-container');
        const favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        if(products.length === 0) {
            container.innerHTML = "<h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üò¢</h3>";
            return;
        }

        container.innerHTML = products.map(p => `
            <div class="card">
                <div class="heart-btn ${favorites.includes(p.id) ? 'liked' : ''}" onclick="toggleHeart(${p.id})">‚ù§Ô∏è</div>
                <img src="${p.img}" alt="${p.name}">
                <div>
                    <h3>${p.name}</h3>
                    <div style="color:gray; font-size:12px;">${p.specs || ''}</div>
                    <div style="font-size:18px; margin:10px 0;"><b>$${p.price}</b></div>
                    <button class="btn" onclick="addToCart(${p.id}, '${p.name}', ${p.price})">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>
            </div>
        `).join('');
    }

    // 3. –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ö–∞—Ç–µ–≥–æ—Ä–∏–∏, –õ–∞–π–∫–∏, –¢–µ–º–∞)
    function setCategory(cat) {
        currentCategory = cat;
        showOnlyFavorites = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ª—é–±–∏–º—ã—Ö
        document.getElementById('favFilterBtn').classList.remove('active');
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        applyFilters();
    }

    function toggleFavoritesShow() {
        showOnlyFavorites = !showOnlyFavorites;
        const btn = document.getElementById('favFilterBtn');
        if(showOnlyFavorites) {
            btn.classList.add('active');
            btn.innerText = "‚ù§Ô∏è –¢–æ–ª—å–∫–æ –ª—é–±–∏–º—ã–µ";
        } else {
            btn.classList.remove('active');
            btn.innerText = "‚ù§Ô∏è –õ—é–±–∏–º—ã–µ";
        }
        applyFilters();
    }

    function toggleHeart(id) {
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        if(favorites.includes(id)) {
            favorites = favorites.filter(fid => fid !== id); // –£–¥–∞–ª–∏—Ç—å
        } else {
            favorites.push(id); // –î–æ–±–∞–≤–∏—Ç—å
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
        applyFilters(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å (—á—Ç–æ–±—ã —Å–µ—Ä–¥–µ—á–∫–æ –∑–∞–≥–æ—Ä–µ–ª–æ—Å—å)
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    // 4. –ö–û–†–ó–ò–ù–ê
    function addToCart(id, name, price) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.push({ id, name, price });
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
        const btn = event.target;
        btn.style.background = "#34c759";
        btn.innerText = "–î–æ–±–∞–≤–ª–µ–Ω–æ! ‚úÖ";
        setTimeout(() => { btn.style.background = ""; btn.innerText = "–í –∫–æ—Ä–∑–∏–Ω—É"; }, 1000);
    }

    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        document.getElementById('cartCount').innerText = cart.length;
    }

    load();
</script>
</body>
</html>