<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ | iStore</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #F5F5F7;
            --bg-card: #FFFFFF;
            --text-main: #1D1D1F;
            --text-sec: #86868B;
            --accent: #0071E3;
            --radius: 18px;
        }
        
        body { font-family: "Inter", sans-serif; background: var(--bg-body); margin: 0; padding: 40px 20px; color: var(--text-main); }
        .container { max-width: 800px; margin: 0 auto; }
        
        h1 { font-size: 32px; font-weight: 700; margin-bottom: 30px; }
        
        /* –ö–ê–†–¢–û–ß–ö–ò –¢–û–í–ê–†–û–í */
        .cart-list { background: var(--bg-card); border-radius: var(--radius); padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #eee; }
        .cart-item:last-child { border-bottom: none; }
        
        .item-info b { font-size: 18px; display: block; margin-bottom: 5px; }
        .item-price { color: var(--text-sec); }
        
        .del-btn { color: #FF3B30; background: none; border: none; font-size: 18px; cursor: pointer; padding: 10px; transition: 0.2s; }
        .del-btn:hover { background: #ffe5e5; border-radius: 50%; }

        /* –ò–¢–û–ì–û */
        .summary { margin-top: 30px; text-align: right; }
        .total-price { font-size: 36px; font-weight: 700; margin: 10px 0 20px; letter-spacing: -1px; }
        
        .checkout-btn {
            background: var(--accent); color: white; border: none;
            padding: 16px 40px; font-size: 18px; font-weight: 600; border-radius: 30px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,113,227,0.3);
        }
        .checkout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,113,227,0.5); }
        
        .empty-msg { text-align: center; padding: 40px; color: var(--text-sec); font-size: 18px; }
        
        .back-link { display: inline-block; margin-top: 30px; color: var(--text-sec); text-decoration: none; }
        .back-link:hover { color: var(--accent); }

        /* --- –û–ö–ù–û –û–ü–õ–ê–¢–´ (PAYMENT MODAL) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }

        .pay-card {
            background: white; width: 400px; padding: 30px; border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); text-align: center;
            position: relative; transform: scale(0.9); transition: 0.3s;
        }
        .modal-overlay.open .pay-card { transform: scale(1); }

        .card-visual {
            background: linear-gradient(135deg, #0071E3, #00C6FB);
            height: 180px; border-radius: 16px; color: white; padding: 20px;
            text-align: left; margin-bottom: 25px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,113,227,0.3);
        }
        .card-chip { width: 40px; height: 30px; background: #FFD700; border-radius: 6px; margin-bottom: 10px; opacity: 0.8; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 12px; color: var(--text-sec); margin-bottom: 5px; }
        .pay-input {
            width: 100%; padding: 12px; border: 1px solid #e5e5e5; border-radius: 10px;
            font-size: 16px; outline: none; box-sizing: border-box; transition: 0.3s;
        }
        .pay-input:focus { border-color: var(--accent); }
        
        .row { display: flex; gap: 10px; }

        .pay-btn-final {
            width: 100%; padding: 15px; background: #000; color: white;
            border: none; border-radius: 12px; font-weight: bold; font-size: 16px;
            margin-top: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .pay-btn-final:hover { background: #333; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ */
        .success-animation { display: none; flex-direction: column; align-items: center; padding: 20px; }
        .checkmark { width: 60px; height: 60px; border-radius: 50%; background: #34c759; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        
    </style>
</head>
<body>

<div class="container">
    <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω</a>
    <h1>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h1>

    <div id="cartContent">
        <div class="cart-list" id="cartList"></div>
        
        <div class="summary" id="summaryBlock">
            <div>–ö –æ–ø–ª–∞—Ç–µ:</div>
            <div class="total-price">$<span id="total">0</span></div>
            <button class="checkout-btn" onclick="openPayModal()">–û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="payModal">
    <div class="pay-card">
        <div id="payForm">
            <h2 style="margin-top:0;">–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π</h2>
            
            <div class="card-visual">
                <div class="card-chip"></div>
                <div style="font-size: 20px; letter-spacing: 2px;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                <div style="display:flex; justify-content:space-between; font-size:14px;">
                    <span id="cardHolderName">YOUR NAME</span>
                    <span>09/28</span>
                </div>
            </div>

            <div class="input-group">
                <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                <input type="text" class="pay-input" placeholder="0000 0000 0000 0000" maxlength="19">
            </div>
            
            <div class="row">
                <div class="input-group">
                    <label>–°—Ä–æ–∫ (–ú–ú/–ì–ì)</label>
                    <input type="text" class="pay-input" placeholder="MM/YY" maxlength="5">
                </div>
                <div class="input-group">
                    <label>CVV</label>
                    <input type="password" class="pay-input" placeholder="123" maxlength="3">
                </div>
            </div>

            <button class="pay-btn-final" onclick="processPayment()">
                üîí –û–ø–ª–∞—Ç–∏—Ç—å $<span id="btnTotal">0</span>
            </button>
            <div style="margin-top:10px; font-size:12px; color:gray; cursor:pointer;" onclick="closePayModal()">–û—Ç–º–µ–Ω–∞</div>
        </div>

        <div id="successView" class="success-animation">
            <div class="checkmark">‚úì</div>
            <h3>–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</h3>
            <p style="color:gray;">–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω.</p>
        </div>
    </div>
</div>

<script>
    // 1. –ó–ê–ì–†–£–ó–ö–ê
    function loadCart() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const list = document.getElementById('cartList');
        const summary = document.getElementById('summaryBlock');
        
        if(cart.length === 0) {
            list.innerHTML = "<div class='empty-msg'>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üçÉ</div>";
            summary.style.display = 'none';
            return;
        }

        let total = 0;
        list.innerHTML = cart.map((item, i) => {
            total += item.price;
            return `
                <div class="cart-item">
                    <div class="item-info">
                        <b>${item.name}</b>
                        <span class="item-price">$${item.price}</span>
                    </div>
                    <button class="del-btn" onclick="removeItem(${i})">üóë</button>
                </div>
            `;
        }).join('');
        
        document.getElementById('total').innerText = total;
        document.getElementById('btnTotal').innerText = total;
        summary.style.display = 'block';
    }

    function removeItem(i) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.splice(i, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        loadCart();
    }

    // 2. –õ–û–ì–ò–ö–ê –û–ü–õ–ê–¢–´
    function openPayModal() {
        document.getElementById('payModal').classList.add('open');
        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        document.getElementById('payForm').style.display = 'block';
        document.getElementById('successView').style.display = 'none';
    }

    function closePayModal() {
        document.getElementById('payModal').classList.remove('open');
    }

    async function processPayment() {
        const btn = document.querySelector('.pay-btn-final');
        const originalText = btn.innerHTML;
        
        // 1. –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–∫–∞
        btn.innerHTML = "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...";
        btn.style.opacity = "0.7";
        
        setTimeout(async () => {
            // 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const userId = localStorage.getItem('userId');

            try {
                const res = await fetch('https://istore-i9oo.onrender.com/api/orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cart, userId })
                });

                if(res.ok) {
                    // 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    document.getElementById('payForm').style.display = 'none';
                    document.getElementById('successView').style.display = 'flex';
                    localStorage.removeItem('cart'); // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
                    
                    // 4. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    setTimeout(() => {
                        window.location.href = '/profile.html';
                    }, 2000);
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ :(");
                    btn.innerHTML = originalText;
                }
            } catch(e) {
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                btn.innerHTML = originalText;
            }
        }, 1500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞
    }

    loadCart();
</script>

</body>
</html>